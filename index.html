<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Hierarchy Explorer</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            bg: '#0F1117',
            surface: '#161A23',
            border: '#252A3A',
            text: { main: '#E6EAF2', muted: '#9AA4BF' },
            brand: { blue: '#4DA3FF', cyan: '#00E5C3', purple: '#8B5CF6', yellow: '#FBBF24' }
          }
        }
      }
    }
  </script>
  <style>
    body { background-color: #0F1117; color: #E6EAF2; }
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #161A23; }
    ::-webkit-scrollbar-thumb { background: #252A3A; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #4DA3FF; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, StrictMode } = React;

    // --- CONFIGURATION ---
    // Update these to match your GitHub repository details
    const GITHUB_USER = "KunalAlgo8";
    const REPO_NAME = "new-database-hierarchy";
    const BRANCH = "main";
    const METADATA_FILE = "metadata-log.json";
    const HIERARCHY_FILE = "hierarchy-log.json";

    // --- FALLBACK DATA ---
    // This is used if hierarchy-log.json cannot be fetched
    const FALLBACK_HIERARCHY = {
      name: "Databases",
      type: "root",
      children: [
        {
          name: "mes",
          type: "main-database",
          children: [
            {
              name: "smartgateplus",
              type: "sub-database",
              children: [
                { name: "dbo", type: "schema", children: [{ name: "setup_change_data", type: "table" }] },
                { name: "dta", type: "schema", children: [{ name: "downtime_department", type: "table" }, { name: "downtime_with_reason", type: "table" }] },
                { name: "master", type: "schema", children: [{ name: "recipe_production", type: "table" }] }
              ]
            }
          ]
        },
        {
          name: "sap",
          type: "main-database",
          children: [
            {
              name: "master",
              type: "sub-database",
              children: [
                { name: "v1", type: "schema", children: [{ name: "BOM_details", type: "table" }, { name: "machine_capacity", type: "table" }] }
              ]
            }
          ]
        }
      ]
    };

    // --- ICONS ---
    const IconDatabase = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
      </svg>
    );

    const IconServer = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
        <line x1="6" y1="6" x2="6.01" y2="6"></line>
        <line x1="6" y1="18" x2="6.01" y2="18"></line>
      </svg>
    );

    const IconFolder = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
      </svg>
    );

    const IconTable = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"></path>
      </svg>
    );

    const IconSearch = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    );

    const IconCopy = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    );

    const IconEdit = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    );

    const IconChevronRight = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const IconEye = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    );

    const IconX = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    // --- SERVICES ---
    const fetchMetadata = async () => {
      try {
        const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/${BRANCH}/${METADATA_FILE}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error("File not found");
        return await response.json();
      } catch (error) {
        console.warn("Could not fetch metadata log, using local empty state.");
        return null;
      }
    };

    const fetchHierarchy = async () => {
      try {
        const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/${BRANCH}/${HIERARCHY_FILE}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error("File not found");
        return await response.json();
      } catch (error) {
        console.warn("Could not fetch hierarchy log, using local default.");
        return null;
      }
    };

    const saveToGitHub = async (filename, content, token, message) => {
      const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/contents/${filename}`;
      
      let sha = null;
      try {
        const existing = await fetch(apiUrl, {
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/vnd.github+json"
          }
        });
        if (existing.ok) {
          const json = await existing.json();
          sha = json.sha;
        }
      } catch (e) {
        // File might not exist yet
      }

      const base64Content = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

      const body = {
        message,
        content: base64Content,
        branch: BRANCH
      };
      if (sha) body.sha = sha;

      const res = await fetch(apiUrl, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const errText = await res.text();
        throw new Error(errText);
      }
    };

    // --- HELPER COMPONENTS ---
    const Input = ({ label, value, onChange, readOnly }) => (
      <div>
        <label className="block text-xs uppercase tracking-wider text-text-muted mb-1.5 font-medium">{label}</label>
        <input 
          value={value} 
          onChange={e => onChange && onChange(e.target.value)}
          readOnly={readOnly}
          className={`w-full bg-surface border border-border rounded-lg px-4 py-2.5 text-text-main focus:border-brand-blue focus:ring-1 focus:ring-brand-blue outline-none transition-all ${readOnly ? 'opacity-60 cursor-not-allowed' : ''}`}
        />
      </div>
    );

    const TextArea = ({ label, value, onChange }) => (
      <div>
        <label className="block text-xs uppercase tracking-wider text-text-muted mb-1.5 font-medium">{label}</label>
        <textarea 
          value={value} 
          onChange={e => onChange(e.target.value)}
          rows={3}
          className="w-full bg-surface border border-border rounded-lg px-4 py-2.5 text-text-main focus:border-brand-blue focus:ring-1 focus:ring-brand-blue outline-none transition-all resize-none"
        />
      </div>
    );

    // --- MODAL COMPONENT ---
    const MetadataModal = ({ isOpen, onClose, onSave, initialData, path }) => {
      const [activeTab, setActiveTab] = useState('machine');
      const [formData, setFormData] = useState({
        machine: { name: '', location: '', owner: '', sourceType: '', refresh: '' },
        table: { database: '', schema: '', table: '', description: '', users: '' },
        fields: [],
        updated_at: ''
      });

      useEffect(() => {
        if (initialData) {
          setFormData(initialData);
        } else {
          setFormData({
            machine: { name: '', location: '', owner: '', sourceType: '', refresh: '' },
            table: { 
              database: path[0] || '', 
              schema: path[path.length - 2] || '', 
              table: path[path.length - 1] || '', 
              description: '', 
              users: '' 
            },
            fields: [],
            updated_at: ''
          });
        }
      }, [initialData, path, isOpen]);

      const updateMachine = (key, value) => {
        setFormData(prev => ({ ...prev, machine: { ...prev.machine, [key]: value } }));
      };

      const updateTable = (key, value) => {
        setFormData(prev => ({ ...prev, table: { ...prev.table, [key]: value } }));
      };

      const addField = () => {
        setFormData(prev => ({
          ...prev,
          fields: [...prev.fields, { field: '', datatype: '', meaning: '', nullable: 'No', value: '' }]
        }));
      };

      const updateField = (index, key, value) => {
        const newFields = [...formData.fields];
        newFields[index] = { ...newFields[index], [key]: value };
        setFormData(prev => ({ ...prev, fields: newFields }));
      };

      const removeField = (index) => {
        setFormData(prev => ({ ...prev, fields: prev.fields.filter((_, i) => i !== index) }));
      };

      const handleSave = () => {
        const finalData = { ...formData, updated_at: new Date().toLocaleString() };
        onSave(finalData);
        onClose();
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-bg border border-border rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            
            {/* Header */}
            <div className="p-6 border-b border-border flex justify-between items-center bg-surface">
              <div className="flex items-center gap-3">
                <span className="p-2 bg-brand-cyan/20 rounded-lg text-brand-cyan"><IconEdit className="w-5 h-5" /></span>
                <h2 className="text-xl font-semibold text-text-main">Edit Metadata</h2>
              </div>
              <button onClick={onClose} className="text-text-muted hover:text-text-main transition-colors">
                <IconX className="w-6 h-6" />
              </button>
            </div>

            {/* Tabs */}
            <div className="flex border-b border-border bg-surface px-6 pt-2 gap-2">
              {[
                { id: 'machine', label: 'üñ• Machine' },
                { id: 'table', label: 'üìä Table' },
                { id: 'fields', label: 'üß© Fields' }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`px-4 py-2 rounded-t-lg text-sm font-medium transition-colors ${
                    activeTab === tab.id 
                      ? 'bg-brand-blue text-white' 
                      : 'bg-bg text-text-muted hover:bg-border hover:text-text-main border border-border border-b-0'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            {/* Body */}
            <div className="p-6 overflow-y-auto flex-1">
              {activeTab === 'machine' && (
                <div className="space-y-4">
                  <Input label="Machine Name" value={formData.machine.name} onChange={v => updateMachine('name', v)} />
                  <Input label="Plant / Location" value={formData.machine.location} onChange={v => updateMachine('location', v)} />
                  <Input label="Owner" value={formData.machine.owner} onChange={v => updateMachine('owner', v)} />
                  <Input label="Source Type (PLC/MES/ERP)" value={formData.machine.sourceType} onChange={v => updateMachine('sourceType', v)} />
                  <Input label="Refresh Frequency" value={formData.machine.refresh} onChange={v => updateMachine('refresh', v)} />
                </div>
              )}

              {activeTab === 'table' && (
                <div className="space-y-4">
                  <Input label="Database" value={formData.table.database} readOnly />
                  <Input label="Schema" value={formData.table.schema} readOnly />
                  <Input label="Table" value={formData.table.table} readOnly />
                  <TextArea label="Description" value={formData.table.description} onChange={v => updateTable('description', v)} />
                  <Input label="Table Users (comma separated)" value={formData.table.users} onChange={v => updateTable('users', v)} />
                </div>
              )}

              {activeTab === 'fields' && (
                <div>
                  <div className="flex justify-end mb-4">
                    <button 
                      onClick={addField}
                      className="flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-brand-cyan to-emerald-600 text-white rounded-md text-sm font-medium shadow hover:shadow-lg transition-all"
                    >
                      <span>+</span> Add Field
                    </button>
                  </div>
                  <div className="overflow-x-auto border border-border rounded-lg">
                    <table className="w-full text-sm text-left">
                      <thead className="bg-surface text-brand-blue uppercase font-semibold">
                        <tr>
                          <th className="p-3 border-r border-border">Field</th>
                          <th className="p-3 border-r border-border">Type</th>
                          <th className="p-3 border-r border-border">Meaning</th>
                          <th className="p-3 border-r border-border">Nullable</th>
                          <th className="p-3 border-r border-border">Value</th>
                          <th className="p-3">Action</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-border">
                        {formData.fields.map((field, idx) => (
                          <tr key={idx} className="bg-bg hover:bg-surface/50">
                            <td className="p-2 border-r border-border"><input className="w-full bg-transparent outline-none text-text-main" value={field.field} onChange={e => updateField(idx, 'field', e.target.value)} placeholder="Name" /></td>
                            <td className="p-2 border-r border-border"><input className="w-full bg-transparent outline-none text-text-main" value={field.datatype} onChange={e => updateField(idx, 'datatype', e.target.value)} placeholder="Type" /></td>
                            <td className="p-2 border-r border-border"><input className="w-full bg-transparent outline-none text-text-main" value={field.meaning} onChange={e => updateField(idx, 'meaning', e.target.value)} placeholder="Meaning" /></td>
                            <td className="p-2 border-r border-border">
                              <select className="w-full bg-transparent outline-none text-text-main bg-bg" value={field.nullable} onChange={e => updateField(idx, 'nullable', e.target.value)}>
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                              </select>
                            </td>
                            <td className="p-2 border-r border-border"><input className="w-full bg-transparent outline-none text-text-main" value={field.value} onChange={e => updateField(idx, 'value', e.target.value)} placeholder="Value" /></td>
                            <td className="p-2 text-center">
                              <button onClick={() => removeField(idx)} className="text-red-500 hover:text-red-400">üóë</button>
                            </td>
                          </tr>
                        ))}
                        {formData.fields.length === 0 && (
                          <tr>
                            <td colSpan={6} className="p-4 text-center text-text-muted italic">No fields defined yet.</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="p-6 border-t border-border bg-surface flex justify-end gap-3">
              <button onClick={onClose} className="px-4 py-2 rounded-lg border border-border hover:bg-border text-text-main transition-colors">
                Cancel
              </button>
              <button onClick={handleSave} className="px-6 py-2 rounded-lg bg-gradient-to-r from-brand-blue to-blue-700 text-white shadow-lg hover:shadow-brand-blue/20 hover:-translate-y-0.5 transition-all">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      );
    };

    // --- TREE ITEM COMPONENT ---
    const SmartTreeItem = (props) => {
      const [isExpanded, setIsExpanded] = useState(false);
      const [showMeta, setShowMeta] = useState(false);
      const currentPath = [...props.path, props.node.name];
      const nodeKey = currentPath.join('.');
      const meta = props.metadataLog[nodeKey];

      // Effects
      useEffect(() => { if (props.expandAllTrigger > 0) setIsExpanded(true); }, [props.expandAllTrigger]);
      useEffect(() => { 
        if (props.collapseAllTrigger > 0) { setIsExpanded(false); setShowMeta(false); }
      }, [props.collapseAllTrigger]);
      
      useEffect(() => {
        if (props.searchTerm && props.node.name.toLowerCase().includes(props.searchTerm.toLowerCase())) {
          setIsExpanded(true);
        }
      }, [props.searchTerm, props.node.name]);

      const hasChildren = props.node.children && props.node.children.length > 0;
      const isTable = props.node.type === 'table';

      const getBadgeClass = (type) => {
        switch (type) {
          case 'main-database': return 'text-brand-blue border-brand-blue/30 bg-brand-blue/10';
          case 'sub-database': return 'text-brand-purple border-brand-purple/30 bg-brand-purple/10';
          case 'schema': return 'text-brand-cyan border-brand-cyan/30 bg-brand-cyan/10';
          case 'table': return 'text-brand-yellow border-brand-yellow/30 bg-brand-yellow/10';
          default: return '';
        }
      };

      return (
        <div className="relative">
          <div 
            className={`
              flex items-center p-2 rounded-lg cursor-pointer transition-all border border-transparent group
              ${props.searchTerm && props.node.name.toLowerCase().includes(props.searchTerm.toLowerCase()) ? 'bg-brand-blue/20 border-brand-blue shadow-[0_0_15px_rgba(77,163,255,0.2)]' : 'hover:bg-white/5 hover:border-white/10'}
              ${isExpanded && hasChildren ? 'bg-surface' : ''}
              ${showMeta ? 'border-l-4 border-l-brand-blue bg-brand-blue/5' : ''}
            `}
            onClick={(e) => {
                e.stopPropagation();
                if (hasChildren) setIsExpanded(!isExpanded);
            }}
          >
            <span className={`w-5 h-5 flex items-center justify-center mr-2 text-text-muted transition-transform duration-200 ${isExpanded ? 'rotate-90 text-brand-blue' : ''}`}>
              {hasChildren && <IconChevronRight className="w-4 h-4" />}
            </span>

            <span className="mr-3">
                {props.node.type === 'root' && <IconDatabase className="w-5 h-5 text-brand-blue" />}
                {props.node.type === 'main-database' && <IconDatabase className="w-5 h-5 text-brand-blue" />}
                {props.node.type === 'sub-database' && <IconServer className="w-5 h-5 text-brand-purple" />}
                {props.node.type === 'schema' && <IconFolder className="w-5 h-5 text-brand-cyan" />}
                {props.node.type === 'table' && <IconTable className="w-5 h-5 text-brand-yellow" />}
            </span>

            <span className="font-medium text-sm text-text-main flex-1 truncate select-none">{props.node.name}</span>

            {isTable && (
              <div className="flex items-center gap-1 mr-4 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onClick={(e) => { e.stopPropagation(); props.onCopyPath(currentPath); }} className="p-1.5 rounded hover:bg-brand-cyan hover:text-white text-text-muted" title="Copy Path"><IconCopy className="w-4 h-4" /></button>
                <button onClick={(e) => { e.stopPropagation(); props.onOpenMeta(currentPath); }} className="p-1.5 rounded hover:bg-brand-purple hover:text-white text-text-muted" title="Edit Metadata"><IconEdit className="w-4 h-4" /></button>
                {meta && (
                  <button onClick={(e) => { e.stopPropagation(); setShowMeta(!showMeta); }} className={`p-1.5 rounded ${showMeta ? 'bg-brand-blue text-white' : 'hover:bg-brand-blue hover:text-white text-text-muted'}`} title="View Metadata"><IconEye className="w-4 h-4" /></button>
                )}
              </div>
            )}

            {props.node.type && props.node.type !== 'root' && (
              <span className={`hidden sm:inline-block text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ml-2 whitespace-nowrap ${getBadgeClass(props.node.type)}`}>
                {props.node.type.replace('-', ' ')}
              </span>
            )}
          </div>

          {showMeta && meta && (
            <div className="ml-10 my-2 p-4 bg-gradient-to-br from-surface to-brand-blue/5 border-l-4 border-l-brand-blue border border-border rounded-r-lg shadow-xl">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h4 className="flex items-center gap-2 text-brand-cyan font-bold text-xs uppercase tracking-wider mb-3 border-b border-brand-cyan/20 pb-1">Machine Info</h4>
                    <div className="space-y-1.5 text-xs">
                      <div className="flex justify-between border-b border-border/50 pb-1"><span className="text-text-muted">Machine</span> <span className="text-text-main font-medium text-right">{meta.machine.name || '-'}</span></div>
                      <div className="flex justify-between border-b border-border/50 pb-1"><span className="text-text-muted">Location</span> <span className="text-text-main font-medium text-right">{meta.machine.location || '-'}</span></div>
                      <div className="flex justify-between border-b border-border/50 pb-1"><span className="text-text-muted">Owner</span> <span className="text-text-main font-medium text-right">{meta.machine.owner || '-'}</span></div>
                      <div className="flex justify-between border-b border-border/50 pb-1"><span className="text-text-muted">Source</span> <span className="text-text-main font-medium text-right">{meta.machine.sourceType || '-'}</span></div>
                      <div className="flex justify-between border-b border-border/50 pb-1"><span className="text-text-muted">Refresh</span> <span className="text-text-main font-medium text-right">{meta.machine.refresh || '-'}</span></div>
                    </div>
                  </div>
                  <div>
                    <h4 className="flex items-center gap-2 text-brand-blue font-bold text-xs uppercase tracking-wider mb-3 border-b border-brand-blue/20 pb-1">Table Info</h4>
                    <div className="space-y-1.5 text-xs">
                      <div className="flex flex-col gap-1 border-b border-border/50 pb-2">
                        <span className="text-text-muted">Description</span> 
                        <span className="text-text-main italic">{meta.table.description || "No description provided."}</span>
                      </div>
                      <div className="flex flex-col gap-1 border-b border-border/50 pb-2">
                        <span className="text-text-muted">Users</span> 
                        <span className="text-text-main">{meta.table.users || "-"}</span>
                      </div>
                      <div className="flex justify-between pt-1"><span className="text-text-muted">Updated</span> <span className="text-text-main font-mono text-[10px]">{meta.updated_at}</span></div>
                    </div>
                  </div>
              </div>
              {meta.fields.length > 0 && (
                <div className="mt-4">
                    <h4 className="text-brand-purple font-bold text-xs uppercase tracking-wider mb-2">Schema Fields</h4>
                    <div className="overflow-x-auto rounded border border-border">
                      <table className="w-full text-xs text-left">
                        <thead className="bg-black/40 text-text-muted uppercase font-semibold">
                          <tr>
                            <th className="p-2">Field</th>
                            <th className="p-2">Type</th>
                            <th className="p-2">Meaning</th>
                            <th className="p-2">Nullable</th>
                            <th className="p-2">Value</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-border">
                          {meta.fields.map((f, i) => (
                            <tr key={i} className="hover:bg-white/5">
                              <td className="p-2 font-mono text-brand-blue">{f.field}</td>
                              <td className="p-2 text-brand-purple">{f.datatype}</td>
                              <td className="p-2 text-text-main">{f.meaning}</td>
                              <td className="p-2 text-text-muted">{f.nullable}</td>
                              <td className="p-2 text-text-muted">{f.value}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                </div>
              )}
            </div>
          )}

          {hasChildren && isExpanded && (
            <div className="border-l-2 border-border ml-5 pl-4 mt-1 mb-2 animate-in slide-in-from-top-1 fade-in duration-200">
              {props.node.children?.map((child, i) => (
                <SmartTreeItem 
                  key={i} 
                  node={child} 
                  path={currentPath} 
                  metadataLog={props.metadataLog}
                  expandAllTrigger={props.expandAllTrigger}
                  collapseAllTrigger={props.collapseAllTrigger}
                  searchTerm={props.searchTerm}
                  onOpenMeta={props.onOpenMeta}
                  onCopyPath={props.onCopyPath}
                />
              ))}
            </div>
          )}
        </div>
      );
    };

    const StatItem = ({ label, value, color }) => (
      <div className="flex flex-col items-center">
        <span className={`text-xl font-bold ${color}`}>{value}</span>
        <span className="text-[10px] uppercase tracking-wider text-text-muted">{label}</span>
      </div>
    );

    // --- MAIN APP COMPONENT ---
    const App = () => {
      const [hierarchy, setHierarchy] = useState(FALLBACK_HIERARCHY);
      const [metadataLog, setMetadataLog] = useState({});
      const [searchTerm, setSearchTerm] = useState('');
      const [expandTrigger, setExpandTrigger] = useState(0);
      const [collapseTrigger, setCollapseTrigger] = useState(0);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingPath, setEditingPath] = useState([]);
      const [notification, setNotification] = useState(null);

      // Stats
      const stats = useMemo(() => {
        const counts = { mainDb: 0, subDb: 0, schema: 0, table: 0 };
        const traverse = (node) => {
          if (node.type === 'main-database') counts.mainDb++;
          if (node.type === 'sub-database') counts.subDb++;
          if (node.type === 'schema') counts.schema++;
          if (node.type === 'table') counts.table++;
          node.children?.forEach(traverse);
        };
        traverse(hierarchy);
        return counts;
      }, [hierarchy]);

      // Initialization
      useEffect(() => {
        const init = async () => {
          const meta = await fetchMetadata();
          if (meta) setMetadataLog(meta);

          const remoteHierarchy = await fetchHierarchy();
          if (remoteHierarchy) setHierarchy(remoteHierarchy);
        };
        init();
      }, []);

      const handleOpenMeta = (path) => {
        setEditingPath(path);
        setIsModalOpen(true);
      };

      const handleCopyPath = (path) => {
        const formatted = '["' + path.join('/') + '"]';
        navigator.clipboard.writeText(formatted);
        setNotification({ msg: 'Path copied to clipboard!', type: 'success' });
        setTimeout(() => setNotification(null), 2000);
      };

      const handleSaveMetadata = async (newMeta) => {
        const key = editingPath.join('.');
        const updatedLog = { ...metadataLog, [key]: newMeta };
        setMetadataLog(updatedLog);

        try {
          const token = prompt("Enter GitHub Personal Access Token to save (leave empty to just update locally):");
          if (token) {
            await saveToGitHub(METADATA_FILE, updatedLog, token, `Update metadata for ${key}`);
            setNotification({ msg: 'Saved to GitHub successfully!', type: 'success' });
          } else {
            setNotification({ msg: 'Updated locally (not saved to GitHub)', type: 'info' });
          }
        } catch (e) {
          console.error(e);
          setNotification({ msg: `Failed to save: ${e.message}`, type: 'error' });
        }
      };

      return (
        <div className="min-h-screen font-sans text-text-main bg-bg selection:bg-brand-blue/30">
          
          {/* Header */}
          <header className="sticky top-0 z-40 bg-bg/80 backdrop-blur-md border-b border-border shadow-2xl">
            <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-black to-blue-900 flex items-center justify-center text-2xl shadow-lg shadow-brand-blue/20">
                  üóÑÔ∏è
                </div>
                <div>
                  <h1 className="text-xl font-bold tracking-tight text-white">Database Hierarchy Explorer</h1>
                  <p className="text-xs text-text-muted tracking-wide">Enterprise MES & SAP Database Structure</p>
                </div>
              </div>
              
              <div className="flex gap-4">
                 <div className="hidden lg:flex gap-6 bg-surface px-6 py-2 rounded-lg border border-border">
                    <StatItem label="DBs" value={stats.mainDb} color="text-brand-blue" />
                    <StatItem label="Sub" value={stats.subDb} color="text-brand-purple" />
                    <StatItem label="Schemas" value={stats.schema} color="text-brand-cyan" />
                    <StatItem label="Tables" value={stats.table} color="text-brand-yellow" />
                 </div>
              </div>
            </div>

            {/* Controls Bar */}
            <div className="border-t border-border bg-surface/50">
              <div className="max-w-7xl mx-auto px-6 py-3 flex flex-wrap gap-4 items-center justify-between">
                <div className="flex gap-3">
                  <button 
                    onClick={() => setExpandTrigger(prev => prev + 1)}
                    className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-900 to-slate-900 border border-border rounded-lg text-sm font-medium hover:border-brand-blue transition-all hover:shadow-lg hover:shadow-brand-blue/10"
                  >
                    üìÇ Expand All
                  </button>
                  <button 
                    onClick={() => setCollapseTrigger(prev => prev + 1)}
                    className="flex items-center gap-2 px-4 py-2 bg-surface border border-border rounded-lg text-sm font-medium hover:bg-border transition-all"
                  >
                    üìÅ Collapse All
                  </button>
                </div>
                
                <div className="relative flex-1 max-w-md group">
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted group-focus-within:text-brand-blue transition-colors">
                    <IconSearch className="w-4 h-4" />
                  </div>
                  <input 
                    type="text" 
                    placeholder="Search databases, schemas, tables..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full bg-bg border border-border rounded-lg py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-brand-blue focus:ring-1 focus:ring-brand-blue transition-all"
                  />
                </div>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <main className="max-w-7xl mx-auto px-6 py-8">
            <div className="bg-bg rounded-2xl border border-border shadow-2xl p-6 min-h-[600px] overflow-x-auto relative">
               
               {/* Grid Background Effect */}
               <div className="absolute inset-0 bg-[linear-gradient(rgba(37,42,58,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(37,42,58,0.1)_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none"></div>

               {/* Tree Root */}
               <div className="relative z-10">
                 {hierarchy.children && hierarchy.children.map((child, idx) => (
                   <SmartTreeItem 
                     key={idx} 
                     node={child} 
                     path={[]} 
                     metadataLog={metadataLog}
                     expandAllTrigger={expandTrigger} 
                     collapseAllTrigger={collapseTrigger}
                     searchTerm={searchTerm}
                     onOpenMeta={handleOpenMeta}
                     onCopyPath={handleCopyPath}
                   />
                 ))}
               </div>
            </div>
          </main>

          {/* Notification Toast */}
          {notification && (
            <div className={`fixed top-24 right-6 px-6 py-4 rounded-xl shadow-2xl border border-white/10 flex items-center gap-3 animate-in slide-in-from-right fade-in duration-300 z-50 ${
              notification.type === 'success' ? 'bg-gradient-to-r from-emerald-600 to-emerald-800 text-white' : 
              notification.type === 'error' ? 'bg-gradient-to-r from-red-600 to-red-800 text-white' : 
              'bg-surface border-brand-blue text-text-main'
            }`}>
              <span className="text-xl">{notification.type === 'success' ? '‚úì' : notification.type === 'error' ? '‚úï' : '‚Ñπ'}</span>
              <span className="font-medium">{notification.msg}</span>
            </div>
          )}

          {/* Modal */}
          <MetadataModal 
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            onSave={handleSaveMetadata}
            initialData={metadataLog[editingPath.join('.')] || null}
            path={editingPath}
          />

        </div>
      );
    };

    // --- RENDER ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<StrictMode><App /></StrictMode>);
  </script>
</body>
</html>
